<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Frequ√™ncia - Firestore</title>
    <!-- Carrega Tailwind CSS para estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o do Inter Font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#f97316',
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos customizados para melhorar o visual */
        .container-app {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1rem;
        }
        .scrollable-content {
            max-height: 50vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <div class="container-app">
        <!-- Card Principal da Aplica√ß√£o -->
        <div class="w-full max-w-2xl bg-white p-6 md:p-8 rounded-xl shadow-2xl space-y-6">
            
            <header class="pb-4 border-b border-gray-200">
                <h1 class="text-3xl font-extrabold text-primary">Registro de Frequ√™ncia üóìÔ∏è</h1>
                <p id="userIdDisplay" class="text-xs text-gray-500 mt-1">Usu√°rio: Carregando...</p>
            </header>

            <!-- Loading State -->
            <div id="loading" class="flex items-center justify-center p-8 bg-indigo-50 rounded-lg">
                <svg class="animate-spin h-5 w-5 text-primary mr-3" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Conectando ao banco de dados...</span>
            </div>

            <!-- Formul√°rio e Listas (Vis√≠vel ap√≥s o carregamento) -->
            <div id="appContent" class="hidden space-y-6">
                
                <!-- 1. Sele√ß√£o de Turma -->
                <section class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">Selecione a Turma Base</h2>
                    <div class="flex flex-col md:flex-row gap-4">
                        <select id="classSelect" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <option value="">-- Selecione uma Turma --</option>
                        </select>
                        <button id="loadClassBtn" class="bg-primary hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150">
                            Carregar Lista
                        </button>
                    </div>
                    <p class="text-sm text-red-500 mt-2 hidden" id="classError">Selecione uma turma para continuar.</p>
                </section>

                <!-- 2. Registro de Frequ√™ncia -->
                <section id="attendanceSection" class="p-4 bg-white border border-secondary/30 rounded-lg shadow-inner hidden space-y-4">
                    <h2 class="text-xl font-semibold text-gray-700 flex justify-between items-center">
                        Registro para Turma: <span id="currentClassName" class="text-secondary font-bold"></span>
                    </h2>
                    
                    <div class="flex space-x-4 items-center">
                        <label for="attendanceDate" class="text-gray-600">Data:</label>
                        <input type="date" id="attendanceDate" class="p-2 border border-gray-300 rounded-lg flex-grow max-w-xs" required>
                    </div>

                    <div id="studentListContainer" class="scrollable-content border border-gray-300 rounded-lg p-3 bg-white">
                        <!-- Lista de alunos ser√° injetada aqui -->
                        <p class="text-gray-500 text-center py-4">Nenhum aluno carregado. Selecione uma turma acima.</p>
                    </div>

                    <div class="flex justify-between items-center pt-2">
                        <button id="saveAttendanceBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 disabled:opacity-50" disabled>
                            Salvar Frequ√™ncia
                        </button>
                        <button id="exportDataBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150" disabled>
                            Exportar Turma (CSV)
                        </button>
                    </div>
                </section>

                <!-- Modal para Adicionar Turma (Opcional, para demonstrar o banco) -->
                <button id="showAddClassModalBtn" class="text-sm text-primary hover:text-indigo-700 mt-4 p-2 w-full text-center border border-primary/50 rounded-lg transition duration-150">
                    + Adicionar Nova Turma Base
                </button>
            </div>

            <!-- Mensagem/Modal Customizado -->
            <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full space-y-4">
                    <h3 id="messageTitle" class="text-xl font-bold text-primary"></h3>
                    <p id="messageText" class="text-gray-700"></p>
                    <button id="closeMessageBtn" class="bg-primary hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg float-right">Fechar</button>
                </div>
            </div>

            <!-- Modal para Adicionar Turma -->
            <div id="addClassModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full space-y-4">
                    <h3 class="text-2xl font-bold text-primary mb-4">Adicionar Nova Turma Base</h3>
                    <input type="text" id="classNameInput" placeholder="Nome da Turma (Ex: 3¬∫ B - Matutino)" class="w-full p-3 border border-gray-300 rounded-lg">
                    <textarea id="studentListInput" placeholder="Lista de Alunos (Um nome por linha)" rows="5" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button id="cancelAddClassBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg">Cancelar</button>
                        <button id="saveClassBtn" class="bg-secondary hover:bg-orange-600 text-white font-medium py-2 px-4 rounded-lg">Salvar Turma</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Script de Inicializa√ß√£o e L√≥gica Firebase/JS -->
    <script type="module">
        // Importa√ß√µes do Firebase SDK v11 (m√≠nimo necess√°rio)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, addDoc, getDocs, where, limit, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Configura√ß√µes Globais (Fornecidas pelo ambiente Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // setLogLevel('debug'); // Descomente para ver logs detalhados do Firebase
        
        // Vari√°veis de Estado Global
        let app, db, auth;
        let userId = null;
        let classes = []; // Cache das turmas
        let currentRoster = []; // Lista de alunos da turma selecionada
        let currentClassId = null;

        // Refer√™ncias DOM
        const loadingEl = document.getElementById('loading');
        const appContentEl = document.getElementById('appContent');
        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const classSelectEl = document.getElementById('classSelect');
        const attendanceSectionEl = document.getElementById('attendanceSection');
        const currentClassNameEl = document.getElementById('currentClassName');
        const studentListContainerEl = document.getElementById('studentListContainer');
        const saveAttendanceBtn = document.getElementById('saveAttendanceBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const loadClassBtn = document.getElementById('loadClassBtn');
        const classErrorEl = document.getElementById('classError');
        
        // Refs do Modal de Mensagem
        const messageBox = document.getElementById('messageBox');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const closeMessageBtn = document.getElementById('closeMessageBtn');

        // Refs do Modal Adicionar Turma
        const addClassModal = document.getElementById('addClassModal');
        const showAddClassModalBtn = document.getElementById('showAddClassModalBtn');
        const cancelAddClassBtn = document.getElementById('cancelAddClassBtn');
        const saveClassBtn = document.getElementById('saveClassBtn');
        const classNameInput = document.getElementById('classNameInput');
        const studentListInput = document.getElementById('studentListInput');

        // --- Fun√ß√µes de UI e Utilidade ---

        /**
         * Exibe uma mensagem de feedback para o usu√°rio.
         * @param {string} title 
         * @param {string} text 
         */
        function showMessage(title, text) {
            messageTitle.textContent = title;
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        }

        closeMessageBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
            messageBox.classList.remove('flex');
        });
        
        /**
         * Mostra ou esconde o modal de Adicionar Turma.
         * @param {boolean} show 
         */
        function toggleAddClassModal(show) {
            if (show) {
                addClassModal.classList.remove('hidden');
                addClassModal.classList.add('flex');
            } else {
                addClassModal.classList.add('hidden');
                addClassModal.classList.remove('flex');
            }
        }

        showAddClassModalBtn.addEventListener('click', () => toggleAddClassModal(true));
        cancelAddClassBtn.addEventListener('click', () => toggleAddClassModal(false));

        /**
         * Renderiza a lista de turmas no dropdown e atualiza o estado `classes`.
         * @param {Array} classList 
         */
        function renderClasses(classList) {
            classes = classList; // Atualiza o cache
            classSelectEl.innerHTML = '<option value="">-- Selecione uma Turma --</option>';
            classList.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                classSelectEl.appendChild(option);
            });

            // Restaura a sele√ß√£o anterior, se houver
            if (currentClassId) {
                classSelectEl.value = currentClassId;
            }
        }
        
        /**
         * Renderiza a lista de alunos para registro de presen√ßa.
         */
        function renderRoster() {
            studentListContainerEl.innerHTML = '';
            
            if (currentRoster.length === 0) {
                studentListContainerEl.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum aluno cadastrado nesta turma.</p>';
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'divide-y divide-gray-200';

            currentRoster.forEach(student => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 hover:bg-indigo-50 transition duration-100';
                li.innerHTML = `
                    <span class="text-gray-800 flex-grow">${student.name}</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" data-student-id="${student.id}" class="sr-only peer presence-checkbox">
                        <div class="w-11 h-6 bg-red-400 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        <span class="ml-3 text-sm font-medium text-gray-700">Presente</span>
                    </label>
                `;
                ul.appendChild(li);
            });
            studentListContainerEl.appendChild(ul);
            
            saveAttendanceBtn.disabled = false;
        }

        // --- Fun√ß√µes de Banco de Dados (Firestore) ---

        /**
         * Retorna a refer√™ncia da cole√ß√£o base do usu√°rio.
         * @param {string} collectionName 
         * @returns {object} Refer√™ncia da cole√ß√£o.
         */
        function getUserCollection(collectionName) {
            if (!db || !userId) throw new Error("Database not initialized or User ID missing.");
            // Usamos a cole√ß√£o privada do usu√°rio: /artifacts/{appId}/users/{userId}/{collectionName}
            return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
        }

        /**
         * Inicia o listener em tempo real para as Turmas do usu√°rio.
         */
        function setupClassesListener() {
            const q = query(getUserCollection('classes'));
            onSnapshot(q, (snapshot) => {
                const classList = [];
                snapshot.forEach((doc) => {
                    classList.push({ id: doc.id, ...doc.data() });
                });
                renderClasses(classList);
            }, (error) => {
                console.error("Erro ao carregar turmas:", error);
                showMessage("Erro de Carregamento", "N√£o foi poss√≠vel carregar as turmas do banco de dados.");
            });
        }
        
        /**
         * Adiciona uma nova turma ao banco de dados.
         */
        async function addNewClass() {
            const className = classNameInput.value.trim();
            const studentListText = studentListInput.value.trim();

            if (!className || !studentListText) {
                showMessage("Campos Vazios", "Por favor, preencha o nome da turma e a lista de alunos.");
                return;
            }

            try {
                // 1. Processa a lista de alunos
                const students = studentListText.split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0)
                    .map(name => ({
                        // Cria um ID √∫nico simples para cada aluno
                        id: crypto.randomUUID(), 
                        name: name
                    }));

                if (students.length === 0) {
                    showMessage("Lista Vazia", "A lista de alunos n√£o pode estar vazia.");
                    return;
                }

                // 2. Salva a turma no Firestore
                await addDoc(getUserCollection('classes'), {
                    name: className,
                    // √â melhor armazenar a lista de alunos diretamente aqui para simplicidade
                    students: students, 
                    createdAt: new Date().toISOString()
                });

                toggleAddClassModal(false);
                classNameInput.value = '';
                studentListInput.value = '';
                showMessage("Sucesso!", `A turma "${className}" foi salva no banco de dados.`);

            } catch (error) {
                console.error("Erro ao salvar a turma:", error);
                showMessage("Erro ao Salvar", "N√£o foi poss√≠vel salvar a nova turma. Tente novamente.");
            }
        }
        
        saveClassBtn.addEventListener('click', addNewClass);


        /**
         * Carrega a lista de alunos da turma selecionada.
         */
        loadClassBtn.addEventListener('click', () => {
            currentClassId = classSelectEl.value;
            classErrorEl.classList.add('hidden');
            
            if (!currentClassId) {
                classErrorEl.classList.remove('hidden');
                attendanceSectionEl.classList.add('hidden');
                return;
            }

            const selectedClass = classes.find(c => c.id === currentClassId);
            if (selectedClass) {
                currentRoster = selectedClass.students || [];
                currentClassNameEl.textContent = selectedClass.name;
                document.getElementById('attendanceDate').valueAsDate = new Date(); // Data atual
                
                renderRoster();
                attendanceSectionEl.classList.remove('hidden');
                exportDataBtn.disabled = false;
            } else {
                showMessage("Erro", "Turma selecionada n√£o encontrada.");
            }
        });

        /**
         * Salva o registro de frequ√™ncia atual no Firestore.
         */
        async function saveAttendance() {
            if (!currentClassId) {
                showMessage("Aviso", "Nenhuma turma selecionada para salvar.");
                return;
            }

            const date = document.getElementById('attendanceDate').value;
            if (!date) {
                showMessage("Aviso", "Selecione uma data para o registro.");
                return;
            }

            const checkboxes = document.querySelectorAll('.presence-checkbox');
            const records = Array.from(checkboxes).map(checkbox => ({
                studentId: checkbox.dataset.studentId,
                present: checkbox.checked
            }));

            // Usamos a data e o ID da turma para criar um ID √∫nico para o registro
            const docId = `${currentClassId}_${date}`;

            try {
                await setDoc(doc(getUserCollection('attendance_records'), docId), {
                    classId: currentClassId,
                    date: date,
                    records: records,
                    savedAt: new Date().toISOString(),
                    className: currentClassNameEl.textContent
                });
                showMessage("Sucesso!", `Frequ√™ncia de ${date} salva para a turma ${currentClassNameEl.textContent}.`);
            } catch (error) {
                console.error("Erro ao salvar frequ√™ncia:", error);
                showMessage("Erro ao Salvar", "N√£o foi poss√≠vel salvar o registro de frequ√™ncia.");
            }
        }
        
        saveAttendanceBtn.addEventListener('click', saveAttendance);


        /**
         * Exporta os dados de frequ√™ncia da turma selecionada para CSV.
         */
        async function exportData() {
            if (!currentClassId) {
                showMessage("Aviso", "Nenhuma turma selecionada para exporta√ß√£o.");
                return;
            }
            
            exportDataBtn.disabled = true;

            try {
                // 1. Recupera todos os registros de presen√ßa para esta turma
                const q = query(getUserCollection('attendance_records'), where('classId', '==', currentClassId));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    showMessage("Exporta√ß√£o", "Nenhum registro de frequ√™ncia encontrado para esta turma.");
                    exportDataBtn.disabled = false;
                    return;
                }

                const attendanceHistory = snapshot.docs.map(doc => doc.data());
                const className = currentClassNameEl.textContent;
                
                // 2. Cria o cabe√ßalho CSV: Data, Nome do Aluno 1, Nome do Aluno 2, ...
                const studentNames = currentRoster.map(s => s.name);
                let csvContent = "Data;" + studentNames.join(";") + "\n";

                // 3. Preenche as linhas de dados
                attendanceHistory.forEach(record => {
                    // Mapeia os IDs dos alunos para seus status de presen√ßa
                    const presenceMap = record.records.reduce((map, r) => {
                        map[r.studentId] = r.present ? 'P' : 'F'; // P=Presente, F=Falta
                        return map;
                    }, {});

                    // Cria a linha para a data
                    let row = record.date;
                    currentRoster.forEach(student => {
                        // Garante que a ordem das colunas de presen√ßa corresponda √† ordem dos nomes
                        row += ";" + (presenceMap[student.id] || 'N/D'); // N/D = N√£o Definido
                    });
                    csvContent += row + "\n";
                });

                // 4. Cria e dispara o download do arquivo CSV
                const filename = `${className.replace(/[^a-z0-9]/gi, '_')}_Frequencia_Export.csv`;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                
                if (link.download !== undefined) { 
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showMessage("Exporta√ß√£o Conclu√≠da", `O arquivo CSV "${filename}" foi baixado com sucesso.`);
                } else {
                    // Fallback para navegadores que n√£o suportam 'download' (raros hoje)
                    showMessage("Aviso", "Seu navegador pode n√£o suportar download direto. Copie o conte√∫do da console se necess√°rio.");
                    console.log("Conte√∫do CSV:\n", csvContent);
                }

            } catch (error) {
                console.error("Erro na Exporta√ß√£o:", error);
                showMessage("Erro de Exporta√ß√£o", "Ocorreu um erro ao gerar ou baixar o arquivo CSV.");
            } finally {
                exportDataBtn.disabled = false;
            }
        }

        exportDataBtn.addEventListener('click', exportData);


        // --- Inicializa√ß√£o da Aplica√ß√£o ---
        
        /**
         * Inicializa o Firebase e realiza a autentica√ß√£o.
         */
        async function initializeAppAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     throw new Error("Configura√ß√£o do Firebase n√£o encontrada. Verifique as vari√°veis de ambiente.");
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentica√ß√£o (usa token personalizado ou an√¥nima)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplayEl.textContent = `Usu√°rio: ${userId}`;
                        
                        // Esconde o loading e mostra o conte√∫do principal
                        loadingEl.classList.add('hidden');
                        appContentEl.classList.remove('hidden');
                        
                        // Inicia o listener de turmas ap√≥s a autentica√ß√£o
                        setupClassesListener();
                    } else {
                        // L√≥gica caso a autentica√ß√£o falhe ou o usu√°rio se deslogue
                        userIdDisplayEl.textContent = `Usu√°rio: Desconectado`;
                        loadingEl.textContent = "Erro de autentica√ß√£o. Tente recarregar.";
                    }
                });

            } catch (error) {
                console.error("Erro durante a inicializa√ß√£o:", error);
                loadingEl.innerHTML = `<span class="text-red-600">Erro de Inicializa√ß√£o: ${error.message}.</span>`;
            }
        }

        initializeAppAndAuth();
    </script>
</body>
</html>
